<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>WB Monitoring PRO</title>
    
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css"/>
    <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <style>
        :root { 
            --van-background-2: #121212; 
            --van-nav-bar-background: #1a1a1a; 
            --van-nav-bar-title-text-color: #fff; 
        }
        body { 
            background-color: #000; 
            margin: 0; 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        .chart-card { 
            background: linear-gradient(145deg, #1e1e1e, #141414); 
            border-radius: 24px; 
            border: 1px solid #333; 
            margin-bottom: 16px; 
            padding: 15px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }
        .gauge-box { width: 100%; height: 260px; }
        .status-header { 
            padding: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #111; 
            border-bottom: 1px solid #222;
        }
        .adaptive-label { font-size: 13px; font-weight: 800; letter-spacing: 0.5px; }
        .pulse { animation: pulse-red 1s infinite; color: #ff4d4f; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        
        .log-container { background: #1a1a1a; border-radius: 20px; overflow: hidden; border: 1px solid #333; }
        .log-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 16px; 
            border-bottom: 1px solid #222; 
            font-size: 12px; 
        }
        .crit { background: rgba(255, 77, 79, 0.1); color: #ff4d4f; }
    </style>
</head>
<body>
<div id="app">
    <van-nav-bar title="Wiren Board PRO" border="false"></van-nav-bar>
    
    <div class="status-header">
        <div class="adaptive-label" :class="{pulse: isAdaptive}">
            {{ isAdaptive ? '● АДАПТИВНЫЙ РЕЖИМ (4Гц)' : '● РЕЖИМ: НОРМА' }}
        </div>
        <van-tag color="#222" text-color="#888" size="large" round>SD: 25/64 GB</van-tag>
    </div>

    <div style="padding: 16px; padding-bottom: 100px;">
        
        <div class="chart-card">
            <div id="u-gauge" class="gauge-box"></div>
        </div>

        <van-row gutter="12" style="margin-bottom: 16px;">
            <van-col span="12">
                <div class="chart-card" style="padding: 12px; text-align: center; margin-bottom: 0;">
                    <div style="color: #888; font-size: 11px;">ЧАСТОТА</div>
                    <div style="font-size: 20px; font-weight: bold; color: #39f;">{{ freq }} Гц</div>
                </div>
            </van-col>
            <van-col span="12">
                <div class="chart-card" style="padding: 12px; text-align: center; margin-bottom: 0;">
                    <div style="color: #888; font-size: 11px;">ТОК (Σ)</div>
                    <div style="font-size: 20px; font-weight: bold; color: #f0821d;">{{ totalAmp }} A</div>
                </div>
            </van-col>
        </van-row>

        <div class="log-container">
            <div style="padding: 12px 16px; font-weight: bold; border-bottom: 1px solid #333; font-size: 14px; color: #888;">Журнал событий</div>
            <div v-for="l in logs" :key="l.id" class="log-item" :class="{crit: l.type==='crit'}">
                <span>{{l.time}} — {{l.msg}}</span>
                <span style="font-weight: bold;">{{l.val}}</span>
            </div>
        </div>
    </div>

    <van-tabbar v-model="active" active-color="#f0821d" inactive-color="#444" placeholder>
        <van-tabbar-item icon="chart-trending-o">Обзор</van-tabbar-item>
        <van-tabbar-item icon="orders-o">Журнал</van-tabbar-item>
        <van-tabbar-item icon="setting-o">Админ</van-tabbar-item>
    </van-tabbar>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const active = ref(0);
            const isAdaptive = ref(false);
            const freq = ref(50.0);
            const totalAmp = ref(12.4);
            const logs = ref([
                { id: 1, time: '14:20', msg: 'ПЕРЕКОС ФАЗ', val: '14%', type: 'crit' },
                { id: 2, time: '14:15', msg: 'СЕТЬ В НОРМЕ', val: '230V', type: 'ok' },
                { id: 3, time: '13:50', msg: 'НИЗКОЕ Uа', val: '208V', type: 'crit' }
            ]);

            onMounted(() => {
                const chart = echarts.init(document.getElementById('u-gauge'), 'dark');
                
                const option = {
                    backgroundColor: 'transparent',
                    series: [{
                        type: 'gauge',
                        center: ['50%', '60%'],
                        startAngle: 210,
                        endAngle: -30,
                        min: 190,
                        max: 250,
                        splitNumber: 6,
                        itemStyle: { color: '#f0821d' },
                        progress: { show: true, width: 14, roundCap: true },
                        pointer: { length: '65%', width: 6, itemStyle: { color: 'auto' } },
                        axisLine: { lineStyle: { width: 14, color: [[0.33, '#ff4d4f'], [0.75, '#f0821d'], [1, '#ff4d4f']] } },
                        axisLabel: { distance: 22, color: '#666', fontSize: 11 },
                        anchor: { show: true, size: 16, itemStyle: { borderColor: '#f0821d', borderWidth: 3 } },
                        title: { offsetCenter: [0, '30%'], fontSize: 14, color: '#888', fontWeight: 'bold' },
                        detail: { 
                            valueAnimation: true, 
                            offsetCenter: [0, '65%'], 
                            fontSize: 32, 
                            fontWeight: '800', 
                            color: '#fff', 
                            formatter: '{value} V' 
                        },
                        data: [{ value: 230, name: 'ФАЗА A (RMS)' }]
                    }]
                };

                chart.setOption(option);

                // Живая имитация
                setInterval(() => {
                    const v = +(205 + Math.random() * 45).toFixed(1);
                    isAdaptive.value = v < 210 || v > 245;
                    freq.value = +(49.9 + Math.random() * 0.2).toFixed(2);
                    totalAmp.value = +(10 + Math.random() * 5).toFixed(1);
                    
                    chart.setOption({
                        series: [{ data: [{ value: v, name: 'ФАЗА A (RMS)' }] }]
                    });
                }, 2500);

                // Изменение размера при повороте экрана
                window.addEventListener('resize', () => chart.resize());
            });

            return { active, isAdaptive, logs, freq, totalAmp };
        }
    }).use(vant).mount('#app');

    // Регистрация PWA Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW OK'))
                .catch(err => console.log('SW Error', err));
        });
    }
</script>
</body>
</html>

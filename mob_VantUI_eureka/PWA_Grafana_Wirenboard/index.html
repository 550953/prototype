<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <title>WB Monitoring PRO</title>

    <!-- Vant UI + Vue 3 + ECharts -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css"/>
    <script src="https://fastly.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <style>
        :root {
            --van-background-2: #121212;
            --van-nav-bar-background: #1a1a1a;
            --van-nav-bar-title-text-color: #fff;
            --van-primary-color: #f0821d;
            --van-danger-color: #ff4d4f;
        }
        body {
            background: #000;
            margin: 0;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
        }
        .status-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #111;
            border-bottom: 1px solid #222;
            font-size: 14px;
        }
        .adaptive-label {
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .pulse {
            animation: pulse-red 1.5s infinite;
            color: var(--van-danger-color);
        }
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .chart-card {
            background: linear-gradient(145deg, #1e1e1e, #141414);
            border-radius: 20px;
            border: 1px solid #333;
            margin: 16px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        }
        .gauge-box {
            width: 100%;
            height: 280px;
        }
        .key-stat {
            text-align: center;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 16px;
            margin: 8px 0;
        }
        .key-stat-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .key-stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .log-container {
            background: #1a1a1a;
            border-radius: 20px;
            margin: 16px;
            overflow: hidden;
            border: 1px solid #333;
        }
        .log-header {
            padding: 12px 16px;
            font-weight: bold;
            border-bottom: 1px solid #222;
            color: #888;
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #222;
            font-size: 13px;
        }
        .log-item.crit {
            background: rgba(255, 77, 79, 0.12);
            color: #ff4d4f;
        }
        .log-time { color: #666; }
        .bottom-space { height: 80px; }
    </style>
</head>
<body>
<div id="app">
    <van-nav-bar
        title="WB Monitoring PRO"
        left-text="Назад"
        left-arrow
        @click-left="$router?.back?.()"
    />

    <div class="status-header">
        <div class="adaptive-label" :class="{ pulse: isAdaptive }">
            {{ isAdaptive ? '● АДАПТИВНЫЙ РЕЖИМ (4 Гц)' : '● ШТАТНЫЙ РЕЖИМ' }}
        </div>
        <van-tag type="primary" round size="large">
            SD: {{ sdUsed }} / 64 GB
        </van-tag>
    </div>

    <div style="padding: 0 16px 100px;">
        <!-- Gauge напряжения -->
        <div class="chart-card">
            <div id="voltage-gauge" class="gauge-box"></div>
        </div>

        <!-- Ключевые показатели -->
        <van-row gutter="12">
            <van-col span="8">
                <div class="key-stat">
                    <div class="key-stat-label">Частота</div>
                    <div class="key-stat-value" :style="{ color: freq < 49.8 || freq > 50.2 ? 'var(--van-danger-color)' : '#39f' }">
                        {{ freq.toFixed(2) }} Гц
                    </div>
                </div>
            </van-col>
            <van-col span="8">
                <div class="key-stat">
                    <div class="key-stat-label">Ток Σ</div>
                    <div class="key-stat-value" :style="{ color: totalAmp > 50 ? 'var(--van-danger-color)' : '#f0821d' }">
                        {{ totalAmp.toFixed(1) }} A
                    </div>
                </div>
            </van-col>
            <van-col span="8">
                <div class="key-stat">
                    <div class="key-stat-label">Мощность</div>
                    <div class="key-stat-value">{{ totalPower.toFixed(0) }} кВт</div>
                </div>
            </van-col>
        </van-row>

        <!-- Журнал событий -->
        <div class="log-container">
            <div class="log-header">Последние события</div>
            <div v-for="event in events.slice(0, 5)" :key="event.id" class="log-item" :class="{ crit: event.critical }">
                <span class="log-time">{{ event.time }}</span>
                <span>{{ event.message }}</span>
                <span :style="{ color: event.critical ? 'var(--van-danger-color)' : '#39f' }">
                    {{ event.value }}
                </span>
            </div>
            <div v-if="events.length === 0" style="padding: 20px; text-align: center; color: #666;">
                Нет событий за последний час
            </div>
        </div>
    </div>

    <!-- Нижняя навигация -->
    <van-tabbar v-model="activeTab" active-color="#f0821d" inactive-color="#666">
        <van-tabbar-item icon="chart-trending-o">Обзор</van-tabbar-item>
        <van-tabbar-item icon="description">Журнал</van-tabbar-item>
        <van-tabbar-item icon="setting-o">Настройки</van-tabbar-item>
        <van-tabbar-item icon="user-o">Профиль</van-tabbar-item>
    </van-tabbar>
</div>

<script>
// Глобальная регистрация Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('Service Worker зарегистрирован:', reg))
            .catch(err => console.error('Ошибка регистрации SW:', err));
    });
}

const { createApp, ref, onMounted } = Vue;

createApp({
    setup() {
        const activeTab = ref(0);
        const isAdaptive = ref(false);
        const freq = ref(50.02);
        const totalAmp = ref(18.7);
        const totalPower = ref(4.2);
        const sdUsed = ref(42);
        const events = ref([
            { id: 1, time: '14:32', message: 'Перекос фаз L2-L3', value: '12%', critical: true },
            { id: 2, time: '14:28', message: 'Провал напряжения L1', value: '198 В', critical: true },
            { id: 3, time: '14:15', message: 'Сеть в норме', value: '231–229–230 В', critical: false },
            { id: 4, time: '13:45', message: 'Превышение тока L3', value: '62 A', critical: true }
        ]);

        onMounted(() => {
            // Инициализация графика напряжения (gauge)
            const chart = echarts.init(document.getElementById('voltage-gauge'), 'dark');

            const option = {
                backgroundColor: 'transparent',
                series: [{
                    type: 'gauge',
                    center: ['50%', '55%'],
                    startAngle: 225,
                    endAngle: -45,
                    min: 180,
                    max: 260,
                    splitNumber: 5,
                    axisLine: {
                        lineStyle: {
                            width: 18,
                            color: [
                                [0.23, '#ff4d4f'],  // <210 В — красный
                                [0.75, '#f0821d'],  // 210–245 — оранжевый
                                [1, '#ff4d4f']      // >245 — красный
                            ]
                        }
                    },
                    pointer: { length: '70%', width: 8 },
                    itemStyle: { color: 'auto' },
                    axisLabel: { color: '#666', fontSize: 12, distance: 20 },
                    detail: {
                        valueAnimation: true,
                        offsetCenter: [0, '70%'],
                        fontSize: 36,
                        fontWeight: 'bold',
                        color: '#fff',
                        formatter: '{value} В'
                    },
                    data: [{ value: 230, name: 'L1 (RMS)' }]
                }]
            };

            chart.setOption(option);

            // Имитация живых данных (в реальности — через WebSocket/MQTT)
            setInterval(() => {
                const voltages = [228 + Math.random()*8, 230 + Math.random()*6, 232 + Math.random()*7];
                const avgV = voltages.reduce((a,b)=>a+b,0)/3;
                isAdaptive.value = voltages.some(v => v < 210 || v > 245);
                freq.value = 50 + (Math.random()-0.5)*0.4;
                totalAmp.value = 15 + Math.random()*10;
                totalPower.value = (avgV * totalAmp.value / 1000).toFixed(1);

                chart.setOption({
                    series: [{
                        data: [{ value: avgV.toFixed(1), name: 'Среднее напряжение' }]
                    }]
                });
            }, 4000);

            window.addEventListener('resize', () => chart.resize());
        });

        return {
            activeTab,
            isAdaptive,
            freq,
            totalAmp,
            totalPower,
            sdUsed,
            events
        };
    }
}).use(vant).mount('#app');
</script>
</body>
</html>
